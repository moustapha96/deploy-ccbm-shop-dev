import{x as ie,u as oe,j as e,M as P,y as ce,f as S,t as w,n as V,J as L,B as d,z as me,K as C}from"./index-D2o1u-UB.js";import{b as l,u as de}from"./vendor-DZBautpX.js";const ue="/assets/images/wave-image-DnO_I3CT.png",xe="/assets/images/om-image-CBEzpwAR.png",pe=["70","75","76","77","78"],q=x=>{if(!x)return"";let a=String(x).replace(/[^\d]+/g,"");return a.startsWith("00221")?a=a.slice(5):a.startsWith("221")?a=a.slice(3):a.startsWith("0")&&(a=a.slice(1)),a.length===9&&pe.includes(a.slice(0,2))?`221${a}`:(a.length===12&&a.startsWith("221"),a)},he=x=>/^221(70|75|76|77|78)\d{7}$/.test(x),fe=(x="REF")=>`${x}-${Date.now()}-${Math.random().toString(36).slice(2,8).toUpperCase()}`,ge=(x,a,g,s,m)=>[x,a,g,s,m,Date.now()].filter(Boolean).join("-"),ye=()=>typeof navigator!="undefined"&&/Android|iPhone|iPad|iPod|IEMobile|Opera Mini/i.test(navigator.userAgent),Ne=({handlePay:x,totalAmount:a,onClose:g,order:s,idOrder:m})=>{l.useEffect(()=>{localStorage.setItem("idOrderPayment",""),localStorage.setItem("montant",""),localStorage.setItem("tokenOrderPayment",""),localStorage.setItem("statusOrderPayment",""),localStorage.setItem("idDataPayment",""),localStorage.setItem("mm_transaction_id",""),localStorage.setItem("mm_method","")},[]);const N=de(),{setUserPayment:I,setOrder:M}=l.useContext(ie),{user:f,token:je}=oe(),[y,j]=l.useState(!1),[B,k]=l.useState(!0),[n,$]=l.useState(""),[v,D]=l.useState(""),[Q,A]=l.useState(!1),[X,H]=l.useState(""),[J,K]=l.useState(""),[R,z]=l.useState(!1),[E,G]=l.useState(null),[F,Y]=l.useState(null),[T,Z]=l.useState(null),p=l.useRef(null),h=l.useRef(null);l.useEffect(()=>{I&&I(f),M&&M(s)},[]),l.useEffect(()=>()=>{p.current&&clearInterval(p.current),h.current&&clearTimeout(h.current)},[]);const ee=r=>he(q(r)),te=async r=>{if(r.preventDefault(),!n){d.error("Veuillez sélectionner une méthode de paiement",{position:"top-center",autoClose:3e3});return}if(!v){d.error("Veuillez entrer votre numéro de téléphone",{position:"top-center",autoClose:3e3});return}const u=q(v);if(!ee(u)){d.error("Numéro invalide. Utilisez 77/78/76/75/70 au format 221771234567",{position:"top-center",autoClose:4e3});return}j(!0);try{me(m,a,(s&&s.order_lines||[]).map(o=>({name:o.product_name,price:o.price_unit,quantity:o.product_uom_qty})));const t=ge(f&&f.id,m,Math.ceil(a),s&&s.name,s&&s.type_sale),c=fe(n==="wave"?"WAV":"OM");H(c);const re=n==="wave"?`${window.location.origin}/wave-paiement?transaction=${encodeURIComponent(t)}`:`${window.location.origin}/om-paiement?transaction=${encodeURIComponent(t)}`,i=await C.initiatePayment(n,{transaction_id:t,order_id:m,partner_id:f&&f.id,phoneNumber:u,amount:Math.ceil(a),description:`${s&&s.name||"Commande"} - ${m}`,reference:c,success_url:re}),ve={transaction_id:t,amount:Math.ceil(a),order_id:m,order_type:s&&s.type_sale,order_name:s&&s.name,partner_id:f&&f.id,payment_token:c,payment_state:"pending",payment_method:n,customer_phone:u,provider_status:i&&i.status||"pending"};localStorage.setItem("idOrderPayment",String(m)),localStorage.setItem("montant",String(Math.ceil(a))),localStorage.setItem("tokenOrderPayment",c),localStorage.setItem("statusOrderPayment","pending"),localStorage.setItem("mm_transaction_id",t),localStorage.setItem("mm_method",n),K(t),A(!0);const O=ye();if(n==="orange"){const o=i&&i.qr_code_base64,_=i&&i.deep_link_maxit||i&&i.deep_link||i&&i.short_link;if(O&&_)Y(_),window.location.href=_;else if(o){const le=o.startsWith("data:image")?o:`data:image/png;base64,${o}`;G(le)}}if(n==="wave"){const o=i&&i.payment_url||i&&i.deep_link||i&&i.short_link;o&&(Z(o),O?window.location.href=o:window.open(o,"_blank","noopener,noreferrer"))}d.success(`Demande envoyée via ${n==="wave"?"Wave":"Orange Money"}. Validez sur votre téléphone.`,{position:"top-center",autoClose:5e3}),se(t,n)}catch(t){console.error(t),d.error(`Erreur lors du paiement: ${t&&t.message||"échec inconnu"}`,{position:"top-center",autoClose:5e3})}finally{j(!1)}},se=(r,u)=>{p.current&&clearInterval(p.current),h.current&&clearTimeout(h.current),z(!0),p.current=setInterval(async()=>{try{const t=await C.verifyPayment(u,r),c=String(t&&t.status||t&&t.transaction&&t.transaction.status||"").toLowerCase();["completed","success","succeeded"].includes(c)?await U():["failed","canceled","cancelled","rejected","expired"].includes(c)&&await W(t&&t.reason||`Paiement ${c}`)}catch(t){console.warn("Polling error:",t&&t.message)}},4e3),h.current=setTimeout(()=>{b(),d.info("Toujours en attente de confirmation… Vous pouvez relancer la vérification.",{position:"top-center"})},12e4)},b=()=>{p.current&&clearInterval(p.current),h.current&&clearTimeout(h.current),p.current=null,h.current=null,z(!1)},U=async()=>{b();try{d.success("Paiement confirmé avec succès !",{position:"top-center",autoClose:3e3}),(s&&s.type_sale)==="preorder"?N(`/pre-commandes/${m}/détails`):(s&&s.type_sale)==="creditorder"?N(`/credit-commandes/${m}/détails`):N(`/commandes/${m}/détails`),k(!1)}catch(r){console.error(r),d.error("Paiement reçu mais échec de mise à jour locale.",{position:"top-center"})}},W=async r=>{b(),d.error(`Paiement échoué: ${r||"Refusé par l'opérateur"}`,{position:"top-center",autoClose:5e3})},ae=async()=>{const r=J||localStorage.getItem("mm_transaction_id"),u=n||localStorage.getItem("mm_method");if(!(!r||!u)){j(!0);try{const t=await C.verifyPayment(u,r),c=String(t&&t.status||t&&t.transaction&&t.transaction.status||"").toLowerCase();["completed","success","succeeded"].includes(c)?await U():["failed","canceled","cancelled","rejected","expired"].includes(c)?await W(t&&t.reason||`Paiement ${c}`):d.warning("Toujours en attente de validation sur votre téléphone.",{position:"top-center",autoClose:4e3})}catch(t){d.error(`Erreur lors de la vérification: ${t&&t.message||"inconnue"}`,{position:"top-center",autoClose:5e3})}finally{j(!1)}}},ne=()=>{b(),k(!1),g&&g()};return e.jsxs(P,{size:"xl",className:"h-auto",show:B,popup:!0,onClose:g,children:[e.jsx(P.Header,{}),e.jsx(P.Body,{children:e.jsx("div",{className:"fixed inset-0 p-4 flex flex-wrap justify-center items-center w-full h-full z-[1000] before:fixed before:inset-0 before:w-full before:h-full before:bg-[rgba(0,0,0,0.5)] overflow-auto font-[sans-serif]",children:e.jsxs("div",{className:"w-full max-w-lg bg-white shadow-lg rounded-lg p-8 relative",children:[e.jsxs("div",{className:"flex items-start border-b border-gray-300 pb-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("h3",{className:"text-gray-800 text-xl font-bold",children:["Paiement"," ",(s&&s.type_sale)==="order"?"Commande":(s&&s.type_sale)==="preorder"?"Pré-Commande":"Commande à crédit"]}),e.jsx("p",{className:"text-gray-600 text-sm mt-1",children:"Résumé détaillé de votre commande."})]}),e.jsx("p",{children:e.jsx(ce,{onClick:ne,className:"cursor-pointer hover:text-red-500 hover:scale-150 duration-300"})})]}),s&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"my-8",children:[e.jsx("table",{className:"w-full",children:e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left text-gray-800 text-sm py-2",children:"Nom de la commande :"}),e.jsx("th",{className:"text-right text-gray-800 text-sm py-2",children:s.name})]})})}),e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left text-gray-800 text-sm py-2",children:"Nom produit"}),e.jsx("th",{className:"text-right text-gray-800 text-sm py-2",children:"Prix total"})]})}),e.jsx("tbody",{children:(s.order_lines||[]).map((r,u)=>e.jsxs("tr",{children:[e.jsxs("td",{className:"text-left text-gray-800 text-sm py-2",children:[r.product_name," (",r.product_uom_qty,")"]}),e.jsx("td",{className:"text-right text-gray-800 text-sm py-2 font-medium",children:S(r.price_total)})]},u))})]}),e.jsx("table",{className:"w-full",children:e.jsxs("thead",{children:[e.jsxs("tr",{children:[e.jsx("th",{className:"text-left text-gray-800 text-sm py-2",children:"Total Commande (FCFA) :"}),e.jsx("th",{className:"text-right text-gray-800 text-sm py-2",children:S(Math.ceil(s.amount_total))})]}),e.jsxs("tr",{children:[e.jsx("th",{className:"text-left text-gray-800 text-sm py-2",children:"Montant à payer (FCFA) :"}),e.jsx("th",{className:"text-right text-gray-800 text-sm py-2",children:S(Math.ceil(a))})]})]})}),Q?e.jsxs("div",{className:"mt-6 space-y-6",children:[e.jsxs("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4",children:[e.jsx("h4",{className:"text-yellow-800 font-medium mb-2",children:"Paiement en attente"}),e.jsx("p",{className:"text-yellow-700 text-sm",children:"Vérifiez votre téléphone et confirmez le paiement."}),e.jsxs("p",{className:"text-yellow-700 text-sm mt-2",children:["Référence: ",e.jsx("span",{className:"font-medium",children:X})]})]}),n==="orange"&&e.jsxs(e.Fragment,{children:[E&&e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("img",{src:E,alt:"QR Orange Money",className:"w-60 h-60 object-contain border rounded-lg"}),e.jsx("p",{className:"text-xs text-gray-500 mt-2 text-center",children:"Scannez ce QR dans l’app Orange Money pour finaliser."})]}),F&&e.jsxs(w,{onClick:()=>window.location.href=F,pill:!0,className:"rounded-lg px-5 py-2.5 font-medium w-full bg-orange-600 hover:bg-orange-700 text-white",children:["Ouvrir Orange Money ",e.jsx(L,{className:"ml-2 inline h-4 w-4"})]})]}),n==="wave"&&T&&e.jsxs(w,{onClick:()=>window.location.href=T,pill:!0,className:"rounded-lg px-5 py-2.5 font-medium w-full bg-blue-600 hover:bg-blue-700 text-white",children:["Ouvrir Wave ",e.jsx(L,{className:"ml-2 inline h-4 w-4"})]}),e.jsx("div",{className:"flex max-sm:flex-col items-center gap-4",children:e.jsx(w,{onClick:ae,disabled:y||R,pill:!0,className:"rounded-lg px-5 py-2.5 font-medium w-full bg-green-600 hover:bg-green-700 text-white text-xl",children:y?e.jsxs(e.Fragment,{children:[e.jsx(V,{className:"mr-2 h-4 w-4 animate-spin"}),e.jsx("p",{children:"Vérification..."})]}):R?"Vérification automatique en cours…":"Vérifier le paiement"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mt-6 mb-4",children:[e.jsx("h4",{className:"text-gray-800 font-medium mb-3",children:"Choisissez votre méthode de paiement"}),e.jsxs("div",{className:"flex space-x-4",children:[e.jsx("div",{className:`flex-1 border rounded-lg p-4 cursor-pointer transition-all ${n==="wave"?"border-blue-500 bg-blue-50":"border-gray-300 hover:border-blue-300"}`,onClick:()=>$("wave"),children:e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx("img",{src:ue,width:100,alt:""})})}),e.jsx("div",{className:`flex-1 border rounded-lg p-4 cursor-pointer transition-all ${n==="orange"?"border-orange-500 bg-orange-50":"border-gray-300 hover:border-orange-300"}`,onClick:()=>$("orange"),children:e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx("img",{src:xe,width:100,alt:""})})})]})]}),n&&e.jsxs("div",{className:"mt-4 mb-6",children:[e.jsxs("label",{htmlFor:"phone",className:"block text-sm font-medium text-gray-700 mb-1",children:["Numéro ",n==="wave"?"Wave":"Orange Money"]}),e.jsx("input",{type:"tel",id:"phone",value:v,onChange:r=>D(r.target.value),placeholder:"77 123 45 67",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Utilisez un numéro sénégalais (ex: 221771234567). 77/78/76/75/70 acceptés."})]}),e.jsx("div",{className:"flex max-sm:flex-col items-center gap-4 mt-8",children:e.jsx(w,{onClick:te,disabled:y||!n||!v,pill:!0,className:"rounded-lg px-5 !bg-[#487a43]  py-2.5 font-medium w-full hover:bg-red-500 hover:text-white text-xl",children:y?e.jsxs(e.Fragment,{children:[e.jsx(V,{className:"mr-2 h-4 w-4 animate-spin"}),e.jsx("p",{children:"Traitement en cours..."})]}):"Payer maintenant"})})]})]})})]})})})]})};export{Ne as W};
