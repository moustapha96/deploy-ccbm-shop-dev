var _=Object.defineProperty,O=Object.defineProperties;var S=Object.getOwnPropertyDescriptors;var P=Object.getOwnPropertySymbols;var I=Object.prototype.hasOwnProperty,B=Object.prototype.propertyIsEnumerable;var L=(t,n,l)=>n in t?_(t,n,{enumerable:!0,configurable:!0,writable:!0,value:l}):t[n]=l,u=(t,n)=>{for(var l in n||(n={}))I.call(n,l)&&L(t,l,n[l]);if(P)for(var l of P(n))B.call(n,l)&&L(t,l,n[l]);return t},d=(t,n)=>O(t,S(n));import{u as M,f as q,b as m,y as A,j as e,k as U,L as V,B as C}from"./react-vendor-oXU13CxVON7vKjIB.js";import{u as $,L as G,l as F,B as Y,f as z}from"./index-DxAeoNi_vcMUlDbs.js";import{P as y}from"./paimentService-BZriFefE3_EHweaY.js";import"./vendor-CztfEaG7C0izJ0f1.js";import"./ui-libs-DW48STyta0ayNJBW.js";import"./redux-BZdFRlKmMnL7MBoD.js";const p={COMPLETED:"completed",PENDING:"pending",CANCELLED:"cancelled"},v={ORDER:"order",PREORDER:"preorder",CREDITORDER:"creditorder"},H={[v.ORDER]:t=>`/commandes/${t}/détails`,[v.PREORDER]:t=>`/pre-commandes/${t}/détails`,[v.CREDITORDER]:t=>`/credit-commandes/${t}/détails`};function ie({cart:t=!0}){const{user:n}=$(),l=M(),h=q(),[r,x]=m.useState({paymentData:null,isLoading:!1,token:null,error:null}),E=m.useCallback(()=>new URLSearchParams(h.search).get("token"),[h.search]),b=m.useCallback((s,a)=>{const i=H[s];i?l(i(a)):(console.error(`Unknown order type: ${s}`),l("/profile"))},[l]),c=m.useCallback((s,a)=>{A[s](a,{position:"top-right",autoClose:5e3})},[]),N=m.useCallback(async s=>{const{status:a,order_type:i,order_id:f}=s;switch(a){case p.COMPLETED:b(i,f);break;case p.PENDING:c("warning","Le paiement est en attente");break;case p.CANCELLED:c("error","Le paiement a été annulé");break;default:c("warning","Statut de paiement inconnu")}},[b,c]),D=m.useCallback(async(s,a)=>{const{receipt_url:i,customer:f,status:g}=a;try{const o=await y.putPaymentDetailByToken(s,i,f.name,f.email,f.phone,g);console.log(o),o&&o.type_sale&&b(o.type_sale,o.id),b(o.type_sale,o.id)}catch(o){console.log(o),c("warning",o&&o.response&&o.response.data&&o.response.data.message?o.response.data.message:"Erreur lors de la mise à jour du paiement")}},[b,c]),j=m.useCallback(async s=>{x(a=>d(u({},a),{isLoading:!0,error:null}));try{const a=await y.confirmInvoice(s);if(x(i=>d(u({},i),{paymentData:a})),a.response_code==="00"&&a.status===p.COMPLETED){const{receipt_url:i,customer:f,status:g}=a;console.log(a.invoice),a.status!==p.COMPLETED?c("warning","Le paiement n'est pas encore validé"):a.status===p.COMPLETED&&c("success","Le paiement est validé"),await D(s,a)}else a.status===p.CANCELLED?(c("error","Le paiement a été annulé"),await y.putPaymentDetailByToken(s)):a.status===p.PENDING&&c("warning","Le paiement est en attente")}catch(a){console.error("Error confirming payment:",a),x(i=>d(u({},i),{error:"Erreur lors de la confirmation du paiement"})),c("error","Erreur lors de la confirmation du paiement")}finally{x(a=>d(u({},a),{isLoading:!1}))}},[D,c]),k=m.useCallback(async s=>{try{const a=await y.getPaymentDetailsByToken(s);a&&a.payment_state&&a.token_status&&await N(d(u({},a),{status:a.payment_state,order_type:a.order_type,order_id:a.order_id}))}catch(a){console.error("Error checking payment status:",a)}},[N]),T=m.useCallback(()=>{r.paymentData&&r.paymentData.receipt_url&&window.open(r.paymentData.receipt_url,"_blank","noopener,noreferrer")},[r.paymentData&&r.paymentData.receipt_url]),R=m.useCallback(async()=>{r.token&&await j(r.token)},[r.token,j]);m.useEffect(()=>{const s=E();if(!s){x(i=>d(u({},i),{token:null}));return}x(i=>d(u({},i),{token:s})),k(s);const a=setTimeout(()=>{j(s)},1e3);return()=>clearTimeout(a)},[E,k,j]);const w=[{name:"Accueil",path:"/"},{name:"Tableau de bord",path:"/profile"},{name:"Validation Paiement",path:`/payment-state?token=${r.token}`}];return e.jsx(G,{childrenClasses:t?"pt-0 pb-0":"",children:t?e.jsxs("div",{className:"cart-page-wrapper w-full bg-white pb-[60px]",children:[e.jsx("div",{className:"w-full",children:e.jsx(F,{title:"Statut Paiement",breadcrumb:w})}),r.isLoading&&e.jsx(J,{}),r.paymentData&&e.jsx(K,{data:r.paymentData,onOpenInvoice:T}),!r.token&&e.jsx(Z,{onVerify:R})]}):e.jsx("div",{className:"cart-page-wrapper w-full",children:e.jsx("div",{className:"container-x mx-auto",children:e.jsx(Y,{paths:w})})})})}function J(){return e.jsx("div",{className:"flex justify-center items-center w-full h-64",children:e.jsx(U,{size:50,className:"animate-spin text-blue-500"})})}function K({data:t,onOpenInvoice:n}){return e.jsx("div",{className:"w-full mt-[23px]",children:e.jsx("div",{className:"container-x mx-auto",children:e.jsx("div",{className:"checkout-main-content w-full",children:e.jsx("div",{className:"container-x mx-auto",children:e.jsx("div",{className:"w-full lg:flex lg:space-x-[30px]",children:e.jsxs("div",{className:"flex-1",children:[e.jsx("h1",{className:"sm:text-2xl text-xl text-qblack font-medium mb-5",children:"Récapitulatif paiement"}),e.jsxs("div",{className:"w-full px-10 py-[30px] border border-[#EDEDED] rounded-lg",children:[e.jsx(Q,{}),e.jsx(W,{data:t,onOpenInvoice:n})]})]})})})})})})}function Q(){return e.jsxs("div",{className:"sub-total mb-6",children:[e.jsx("div",{className:"flex justify-between mb-5",children:e.jsx("p",{className:"text-[13px] font-medium text-qblack uppercase",children:"Détails Paiement"})}),e.jsx("div",{className:"w-full h-[1px] bg-[#EDEDED]"})]})}function W({data:t,onOpenInvoice:n}){const l=[{label:"Prénom & Nom",value:t.customer.name},{label:"Téléphone",value:t.customer.phone},{label:"Email",value:t.customer.email},{label:"Montant Payé",value:z(t.invoice.total_amount)}];return e.jsxs("div",{className:"product-list w-full mb-[30px]",children:[e.jsxs("ul",{className:"flex flex-col space-y-5",children:[l.map((h,r)=>e.jsx(X,{label:h.label,value:h.value},r)),e.jsx("li",{children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{children:e.jsx("h4",{className:"text-[15px] text-qblack mb-2.5",children:"Facture"})}),e.jsx("div",{children:e.jsx("button",{className:"text-[15px] text-blue-600 font-medium underline hover:text-blue-800 transition-colors",onClick:n,children:"Ouvrir la facture"})})]})})]}),e.jsx("div",{className:"w-full h-[1px] bg-[#EDEDED] mt-6"})]})}function X({label:t,value:n}){return e.jsx("li",{children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{children:e.jsx("h4",{className:"text-[15px] text-qblack mb-2.5",children:t})}),e.jsx("div",{children:e.jsx("span",{className:"text-[15px] text-qblack font-medium",children:n})})]})})}function Z({onVerify:t}){return e.jsx("div",{className:"checkout-main-content w-full",children:e.jsx("div",{className:"container-x mx-auto",children:e.jsx("div",{className:"w-full sm:mb-10 mb-5",children:e.jsx("div",{className:"sm:flex sm:space-x-[18px]",children:e.jsxs("div",{className:"flex-1 w-full mb-5 space-y-4",children:[e.jsx("div",{className:"w-full h-[70px] bg-red-50 border border-red-200 text-red-800 flex justify-center items-center rounded-lg",children:e.jsx("span",{className:"text-[15px] font-medium",children:"Token Non Valide"})}),e.jsx(V,{to:"/boutique",className:"block",children:e.jsx(C,{className:"w-full rounded-lg px-5 py-2.5 font-medium text-xl hover:bg-blue-600 transition-colors",children:"Retour à la boutique"})}),e.jsx(C,{color:"yellow",onClick:t,className:"w-full rounded-lg px-5 py-2.5 font-medium text-xl hover:bg-yellow-500 transition-colors",children:"Vérifier le paiement"})]})})})})})}export{ie as default};
