import{x as oe,u as ie,j as e,M as P,y as ce,f as S,s as b,k as W,I as O,B as m,z as me,J as C}from"./index.ks2_tVCw.js";import{b as l,u as de}from"./vendor.EKSpuOPe.js";const ue="/assets/wave-image.DnO_I3CT.png",xe="/assets/om-image.CBEzpwAR.png",pe=["70","75","76","77","78"],V=u=>{if(!u)return"";let t=String(u).replace(/[^\d]+/g,"");return t.startsWith("00221")?t=t.slice(5):t.startsWith("221")?t=t.slice(3):t.startsWith("0")&&(t=t.slice(1)),t.length===9&&pe.includes(t.slice(0,2))?`221${t}`:(t.length===12&&t.startsWith("221"),t)},he=u=>/^221(70|75|76|77|78)\d{7}$/.test(u),fe=(u="REF")=>`${u}-${Date.now()}-${Math.random().toString(36).slice(2,8).toUpperCase()}`,ge=(u,t,f,r,c)=>[u,t,f,r,c,Date.now()].filter(Boolean).join("-"),ye=()=>typeof navigator<"u"&&/Android|iPhone|iPad|iPod|IEMobile|Opera Mini/i.test(navigator.userAgent),Ne=({handlePay:u,totalAmount:t,onClose:f,order:r,idOrder:c})=>{l.useEffect(()=>{localStorage.setItem("idOrderPayment",""),localStorage.setItem("montant",""),localStorage.setItem("tokenOrderPayment",""),localStorage.setItem("statusOrderPayment",""),localStorage.setItem("idDataPayment",""),localStorage.setItem("mm_transaction_id",""),localStorage.setItem("mm_method","")},[]);const N=de(),{setUserPayment:L,setOrder:q}=l.useContext(oe),{user:g,token:je}=ie(),[y,j]=l.useState(!1),[B,I]=l.useState(!0),[a,M]=l.useState(""),[v,D]=l.useState(""),[Q,A]=l.useState(!1),[X,H]=l.useState(""),[J,G]=l.useState(""),[k,$]=l.useState(!1),[R,K]=l.useState(null),[z,Y]=l.useState(null),[E,Z]=l.useState(null),x=l.useRef(null),p=l.useRef(null);l.useEffect(()=>{L?.(g),q?.(r)},[]),l.useEffect(()=>()=>{x.current&&clearInterval(x.current),p.current&&clearTimeout(p.current)},[]);const ee=n=>he(V(n)),te=async n=>{if(n.preventDefault(),!a){m.error("Veuillez sélectionner une méthode de paiement",{position:"top-center",autoClose:3e3});return}if(!v){m.error("Veuillez entrer votre numéro de téléphone",{position:"top-center",autoClose:3e3});return}const d=V(v);if(!ee(d)){m.error("Numéro invalide. Utilisez 77/78/76/75/70 au format 221771234567",{position:"top-center",autoClose:4e3});return}j(!0);try{me(c,t,(r?.order_lines||[]).map(o=>({name:o.product_name,price:o.price_unit,quantity:o.product_uom_qty})));const s=ge(g?.id,c,Math.ceil(t),r?.name,r?.type_sale),i=fe(a==="wave"?"WAV":"OM");H(i);const re=a==="wave"?`${window.location.origin}/wave-paiement?transaction=${encodeURIComponent(s)}`:`${window.location.origin}/om-paiement?transaction=${encodeURIComponent(s)}`,h=await C.initiatePayment(a,{transaction_id:s,order_id:c,partner_id:g?.id,phoneNumber:d,amount:Math.ceil(t),description:`${r?.name||"Commande"} - ${c}`,reference:i,success_url:re}),ve={transaction_id:s,amount:Math.ceil(t),order_id:c,order_type:r?.type_sale,order_name:r?.name,partner_id:g?.id,payment_token:i,payment_state:"pending",payment_method:a,customer_phone:d,provider_status:h?.status||"pending"};localStorage.setItem("idOrderPayment",String(c)),localStorage.setItem("montant",String(Math.ceil(t))),localStorage.setItem("tokenOrderPayment",i),localStorage.setItem("statusOrderPayment","pending"),localStorage.setItem("mm_transaction_id",s),localStorage.setItem("mm_method",a),G(s),A(!0);const U=ye();if(a==="orange"){const o=h?.qr_code_base64,_=h?.deep_link_maxit||h?.deep_link||h?.short_link;if(U&&_)Y(_),window.location.href=_;else if(o){const le=o.startsWith("data:image")?o:`data:image/png;base64,${o}`;K(le)}}if(a==="wave"){const o=h?.payment_url||h?.deep_link||h?.short_link;o&&(Z(o),U?window.location.href=o:window.open(o,"_blank","noopener,noreferrer"))}m.success(`Demande envoyée via ${a==="wave"?"Wave":"Orange Money"}. Validez sur votre téléphone.`,{position:"top-center",autoClose:5e3}),se(s,a)}catch(s){console.error(s),m.error(`Erreur lors du paiement: ${s?.message||"échec inconnu"}`,{position:"top-center",autoClose:5e3})}finally{j(!1)}},se=(n,d)=>{x.current&&clearInterval(x.current),p.current&&clearTimeout(p.current),$(!0),x.current=setInterval(async()=>{try{const s=await C.verifyPayment(d,n),i=String(s?.status||s?.transaction?.status||"").toLowerCase();["completed","success","succeeded"].includes(i)?await F():["failed","canceled","cancelled","rejected","expired"].includes(i)&&await T(s?.reason||`Paiement ${i}`)}catch(s){console.warn("Polling error:",s?.message)}},4e3),p.current=setTimeout(()=>{w(),m.info("Toujours en attente de confirmation… Vous pouvez relancer la vérification.",{position:"top-center"})},12e4)},w=()=>{x.current&&clearInterval(x.current),p.current&&clearTimeout(p.current),x.current=null,p.current=null,$(!1)},F=async()=>{w();try{m.success("Paiement confirmé avec succès !",{position:"top-center",autoClose:3e3}),r?.type_sale==="preorder"?N(`/pre-commandes/${c}/détails`):r?.type_sale==="creditorder"?N(`/credit-commandes/${c}/détails`):N(`/commandes/${c}/détails`),I(!1)}catch(n){console.error(n),m.error("Paiement reçu mais échec de mise à jour locale.",{position:"top-center"})}},T=async n=>{w(),m.error(`Paiement échoué: ${n||"Refusé par l'opérateur"}`,{position:"top-center",autoClose:5e3})},ae=async()=>{const n=J||localStorage.getItem("mm_transaction_id"),d=a||localStorage.getItem("mm_method");if(!(!n||!d)){j(!0);try{const s=await C.verifyPayment(d,n),i=String(s?.status||s?.transaction?.status||"").toLowerCase();["completed","success","succeeded"].includes(i)?await F():["failed","canceled","cancelled","rejected","expired"].includes(i)?await T(s?.reason||`Paiement ${i}`):m.warning("Toujours en attente de validation sur votre téléphone.",{position:"top-center",autoClose:4e3})}catch(s){m.error(`Erreur lors de la vérification: ${s?.message||"inconnue"}`,{position:"top-center",autoClose:5e3})}finally{j(!1)}}},ne=()=>{w(),I(!1),f?.()};return e.jsxs(P,{size:"xl",className:"h-auto",show:B,popup:!0,onClose:f,children:[e.jsx(P.Header,{}),e.jsx(P.Body,{children:e.jsx("div",{className:"fixed inset-0 p-4 flex flex-wrap justify-center items-center w-full h-full z-[1000] before:fixed before:inset-0 before:w-full before:h-full before:bg-[rgba(0,0,0,0.5)] overflow-auto font-[sans-serif]",children:e.jsxs("div",{className:"w-full max-w-lg bg-white shadow-lg rounded-lg p-8 relative",children:[e.jsxs("div",{className:"flex items-start border-b border-gray-300 pb-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("h3",{className:"text-gray-800 text-xl font-bold",children:["Paiement"," ",r?.type_sale==="order"?"Commande":r?.type_sale==="preorder"?"Pré-Commande":"Commande à crédit"]}),e.jsx("p",{className:"text-gray-600 text-sm mt-1",children:"Résumé détaillé de votre commande."})]}),e.jsx("p",{children:e.jsx(ce,{onClick:ne,className:"cursor-pointer hover:text-red-500 hover:scale-150 duration-300"})})]}),r&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"my-8",children:[e.jsx("table",{className:"w-full",children:e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left text-gray-800 text-sm py-2",children:"Nom de la commande :"}),e.jsx("th",{className:"text-right text-gray-800 text-sm py-2",children:r.name})]})})}),e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left text-gray-800 text-sm py-2",children:"Nom produit"}),e.jsx("th",{className:"text-right text-gray-800 text-sm py-2",children:"Prix total"})]})}),e.jsx("tbody",{children:(r.order_lines||[]).map((n,d)=>e.jsxs("tr",{children:[e.jsxs("td",{className:"text-left text-gray-800 text-sm py-2",children:[n.product_name," (",n.product_uom_qty,")"]}),e.jsx("td",{className:"text-right text-gray-800 text-sm py-2 font-medium",children:S(n.price_total)})]},d))})]}),e.jsx("table",{className:"w-full",children:e.jsxs("thead",{children:[e.jsxs("tr",{children:[e.jsx("th",{className:"text-left text-gray-800 text-sm py-2",children:"Total Commande (FCFA) :"}),e.jsx("th",{className:"text-right text-gray-800 text-sm py-2",children:S(Math.ceil(r.amount_total))})]}),e.jsxs("tr",{children:[e.jsx("th",{className:"text-left text-gray-800 text-sm py-2",children:"Montant à payer (FCFA) :"}),e.jsx("th",{className:"text-right text-gray-800 text-sm py-2",children:S(Math.ceil(t))})]})]})}),Q?e.jsxs("div",{className:"mt-6 space-y-6",children:[e.jsxs("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4",children:[e.jsx("h4",{className:"text-yellow-800 font-medium mb-2",children:"Paiement en attente"}),e.jsx("p",{className:"text-yellow-700 text-sm",children:"Vérifiez votre téléphone et confirmez le paiement."}),e.jsxs("p",{className:"text-yellow-700 text-sm mt-2",children:["Référence: ",e.jsx("span",{className:"font-medium",children:X})]})]}),a==="orange"&&e.jsxs(e.Fragment,{children:[R&&e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("img",{src:R,alt:"QR Orange Money",className:"w-60 h-60 object-contain border rounded-lg"}),e.jsx("p",{className:"text-xs text-gray-500 mt-2 text-center",children:"Scannez ce QR dans l’app Orange Money pour finaliser."})]}),z&&e.jsxs(b,{onClick:()=>window.location.href=z,pill:!0,className:"rounded-lg px-5 py-2.5 font-medium w-full bg-orange-600 hover:bg-orange-700 text-white",children:["Ouvrir Orange Money ",e.jsx(O,{className:"ml-2 inline h-4 w-4"})]})]}),a==="wave"&&E&&e.jsxs(b,{onClick:()=>window.location.href=E,pill:!0,className:"rounded-lg px-5 py-2.5 font-medium w-full bg-blue-600 hover:bg-blue-700 text-white",children:["Ouvrir Wave ",e.jsx(O,{className:"ml-2 inline h-4 w-4"})]}),e.jsx("div",{className:"flex max-sm:flex-col items-center gap-4",children:e.jsx(b,{onClick:ae,disabled:y||k,pill:!0,className:"rounded-lg px-5 py-2.5 font-medium w-full bg-green-600 hover:bg-green-700 text-white text-xl",children:y?e.jsxs(e.Fragment,{children:[e.jsx(W,{className:"mr-2 h-4 w-4 animate-spin"}),e.jsx("p",{children:"Vérification..."})]}):k?"Vérification automatique en cours…":"Vérifier le paiement"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mt-6 mb-4",children:[e.jsx("h4",{className:"text-gray-800 font-medium mb-3",children:"Choisissez votre méthode de paiement"}),e.jsxs("div",{className:"flex space-x-4",children:[e.jsx("div",{className:`flex-1 border rounded-lg p-4 cursor-pointer transition-all ${a==="wave"?"border-blue-500 bg-blue-50":"border-gray-300 hover:border-blue-300"}`,onClick:()=>M("wave"),children:e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx("img",{src:ue,width:100,alt:""})})}),e.jsx("div",{className:`flex-1 border rounded-lg p-4 cursor-pointer transition-all ${a==="orange"?"border-orange-500 bg-orange-50":"border-gray-300 hover:border-orange-300"}`,onClick:()=>M("orange"),children:e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx("img",{src:xe,width:100,alt:""})})})]})]}),a&&e.jsxs("div",{className:"mt-4 mb-6",children:[e.jsxs("label",{htmlFor:"phone",className:"block text-sm font-medium text-gray-700 mb-1",children:["Numéro ",a==="wave"?"Wave":"Orange Money"]}),e.jsx("input",{type:"tel",id:"phone",value:v,onChange:n=>D(n.target.value),placeholder:"77 123 45 67",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Utilisez un numéro sénégalais (ex: 221771234567). 77/78/76/75/70 acceptés."})]}),e.jsx("div",{className:"flex max-sm:flex-col items-center gap-4 mt-8",children:e.jsx(b,{onClick:te,disabled:y||!a||!v,pill:!0,className:"rounded-lg px-5 py-2.5 font-medium w-full hover:bg-red-500 hover:text-white text-xl",children:y?e.jsxs(e.Fragment,{children:[e.jsx(W,{className:"mr-2 h-4 w-4 animate-spin"}),e.jsx("p",{children:"Traitement en cours..."})]}):"Payer maintenant"})})]})]})})]})})})]})};export{Ne as W};
