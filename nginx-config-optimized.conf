# Configuration nginx optimisée pour CCBM Shop - Sans cache
# Fichier: /etc/nginx/conf.d/dev_ccbmshop_com_ng.conf

# Redirection HTTP dev.ccbmshop.com vers HTTPS
server {
    listen 80;
    listen [::]:80;

    server_name dev.ccbmshop.com;

    # Redirect all HTTP requests to HTTPS
    location / {
        return 301 https://dev.ccbmshop.com$request_uri;
    }
}

# Redirection HTTP dev.ccbmshop.sn vers HTTPS dev.ccbmshop.com
server {
    listen 80;
    listen [::]:80;

    server_name dev.ccbmshop.sn;

    # Redirect all HTTP requests to HTTPS dev.ccbmshop.com
    location / {
        return 301 https://dev.ccbmshop.com$request_uri;
    }
}

# Redirection HTTPS dev.ccbmshop.sn vers dev.ccbmshop.com
server {
    listen 443 ssl;
    listen [::]:443 ssl;

    server_name dev.ccbmshop.sn;

    # SSL certificate (peut utiliser le même certificat ou un certificat wildcard)
    ssl_certificate /etc/letsencrypt/live/dev.ccbmshop.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/dev.ccbmshop.com/privkey.pem;

    # Redirect all HTTPS requests to dev.ccbmshop.com
    location / {
        return 301 https://dev.ccbmshop.com$request_uri;
    }
}

# Configuration HTTPS principale
server {
    listen 443 ssl;
    listen [::]:443 ssl;

    server_name dev.ccbmshop.com;

    root /var/www/devccbmshop;
    index index.html index.htm;

    # Headers de sécurité
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Configuration pour les fichiers statiques (JS, CSS, images, fonts)
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        # Désactiver complètement le cache pour tous les assets
        add_header Cache-Control "no-cache, no-store, must-revalidate, max-age=0" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
        
        # Permettre l'accès
        access_log off;
        expires -1;
        
        try_files $uri =404;
    }

    # Configuration pour index.html - AUCUN CACHE
    location = /index.html {
        add_header Cache-Control "no-cache, no-store, must-revalidate, max-age=0" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
        
        # Forcer la revalidation
        etag off;
        if_modified_since off;
    }

    # Configuration pour toutes les autres routes (SPA React Router)
    location / {
        # Désactiver complètement le cache
        add_header Cache-Control "no-cache, no-store, must-revalidate, max-age=0" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
        
        # SPA fallback - toutes les routes pointent vers index.html
        try_files $uri $uri/ /index.html;
        
        # Désactiver le cache pour les requêtes
        etag off;
        if_modified_since off;
    }

    # Bloquer l'accès aux fichiers cachés et sensibles
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Bloquer l'accès aux fichiers de configuration
    location ~* \.(env|log|conf|config|ini|bak|backup|old|tmp)$ {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Configuration des logs
    access_log /var/log/nginx/access.log combined buffer=512k flush=1m;
    error_log /var/log/nginx/error.log warn;

    # Configuration SSL
    ssl_certificate /etc/letsencrypt/live/dev.ccbmshop.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/dev.ccbmshop.com/privkey.pem;
    
    # Optimisations SSL (optionnel mais recommandé)
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers HIGH:!aNULL:!MD5;
}
